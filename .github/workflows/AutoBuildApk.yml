name: Build ByeByeDPI (romanvht) - arm64-v8a

on:
  workflow_dispatch: # Запуск вручную

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout romanvht/ByeByeDPI
        uses: actions/checkout@v4
        with:
          repository: romanvht/ByeByeDPI
          ref: master
          submodules: recursive
          fetch-depth: 1 # Неглубокая копия (1 уровень)

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK (arm64-v8a)
        # Фильтр abi.filters=arm64-v8a заставляет Gradle собирать нативные библиотеки
        # (ByeDPI и tun2socks) только для этой архитектуры.
        run: ./gradlew assembleRelease -Pandroid.injected.build.abi.filters=arm64-v8a --no-daemon

      - name: Sign APK
        run: |
          # 1. Создаем временный ключ
          keytool -genkey -v -keystore temp.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=ByeByeDPI, OU=Build, O=GitHub, C=US"
          
          # 2. Находим собранный APK (он будет unsigned)
          APK_PATH=$(find app/build/outputs/apk/release -name "*-release-unsigned.apk" | head -n 1)
          
          # Если не нашли unsigned, ищем любой release apk
          if [ -z "$APK_PATH" ]; then
            APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -n 1)
          fi
          
          if [ -z "$APK_PATH" ]; then
            echo "::error::APK file not found!"
            exit 1
          fi

          echo "Found APK for signing: $APK_PATH"

          # 3. Подписываем (zipalign + apksigner)
          BUILD_TOOLS_VERSION=$(ls "$ANDROID_SDK_ROOT/build-tools/" | sort -rn | head -n 1)
          ZIPALIGN="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION/apksigner"

          "$ZIPALIGN" -v -p 4 "$APK_PATH" aligned.apk
          "$APKSIGNER" sign --ks temp.keystore --ks-pass pass:android --key-pass pass:android --out ByeByeDPI-arm64-v8a-signed.apk aligned.apk

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: ByeByeDPI-romanvht-arm64
          path: ByeByeDPI-arm64-v8a-signed.apk
